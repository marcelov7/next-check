From d8af44799796b3cb5d1082728c770d37a33c179f Mon Sep 17 00:00:00 2001
From: marcelov7 <marcelov7@users.noreply.github.com>
Date: Tue, 18 Nov 2025 18:00:37 -0300
Subject: [PATCH] =?UTF-8?q?feat(profile):=20perfil=20=E2=80=94=20formul?=
 =?UTF-8?q?=C3=A1rio,=20preview=20e=20upload/remo=C3=A7=C3=A3o=20de=20avat?=
 =?UTF-8?q?ar;=20API=20/api/me=20(GET/PUT)?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 app/api/auth/[...nextauth]/route.ts |  53 +---------
 app/api/me/route.ts                 |  39 +++++++
 app/components/ProfileForm.tsx      | 138 ++++++++++++++++++++++++
 app/perfil/page.tsx                 |   4 +
 dev.log                             | 156 ++++++++++++++++++++++++++++
 lib/nextAuthOptions.ts              |  54 ++++++++++
 6 files changed, 393 insertions(+), 51 deletions(-)
 create mode 100644 app/api/me/route.ts
 create mode 100644 app/components/ProfileForm.tsx
 create mode 100644 lib/nextAuthOptions.ts

diff --git a/app/api/auth/[...nextauth]/route.ts b/app/api/auth/[...nextauth]/route.ts
index 075ad2e..b45b699 100644
--- a/app/api/auth/[...nextauth]/route.ts
+++ b/app/api/auth/[...nextauth]/route.ts
@@ -1,55 +1,6 @@
 import NextAuth from "next-auth";
-import CredentialsProvider from "next-auth/providers/credentials";
-import { compare } from "bcryptjs";
-import { PrismaAdapter } from "@next-auth/prisma-adapter";
-import { prisma } from "@/lib/prisma";
+import authOptions from "@/lib/nextAuthOptions";
 
-const handler = NextAuth({
-  adapter: PrismaAdapter(prisma),
-  session: {
-    strategy: "jwt",
-  },
-  providers: [
-    CredentialsProvider({
-      name: "E-mail e senha",
-      credentials: {
-        email: { label: "E-mail", type: "text" },
-        password: { label: "Senha", type: "password" },
-      },
-      async authorize(credentials) {
-        if (!credentials?.email || !credentials.password) {
-          return null;
-        }
-
-        const user = await prisma.user.findUnique({
-          where: { email: credentials.email },
-        });
-
-        if (!user) return null;
-
-        const isValid = await compare(credentials.password, user.password);
-        if (!isValid) return null;
-
-        return {
-          id: user.id.toString(),
-          name: user.name,
-          email: user.email,
-        };
-      },
-    }),
-  ],
-  callbacks: {
-    async session({ session, token }) {
-      if (session.user && token.sub) {
-        session.user.id = token.sub;
-      }
-      return session;
-    },
-  },
-  pages: {
-    signIn: "/login",
-  },
-  secret: process.env.NEXTAUTH_SECRET,
-});
+const handler = NextAuth(authOptions as any);
 
 export { handler as GET, handler as POST };
diff --git a/app/api/me/route.ts b/app/api/me/route.ts
new file mode 100644
index 0000000..05ce0a5
--- /dev/null
+++ b/app/api/me/route.ts
@@ -0,0 +1,39 @@
+import { NextResponse } from "next/server";
+import { getServerSession } from "next-auth";
+import authOptions from "@/lib/nextAuthOptions";
+import { prisma } from "@/lib/prisma";
+import bcrypt from "bcryptjs";
+
+export async function GET(req: Request) {
+  const session = await getServerSession(authOptions as any);
+  const s: any = session;
+  if (!s || !s.user?.id) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
+  const id = Number(s.user.id);
+  const user = await prisma.user.findUnique({ where: { id }, select: { id: true, name: true, email: true, username: true, image: true } });
+  return NextResponse.json(user);
+}
+
+export async function PUT(req: Request) {
+  const session = await getServerSession(authOptions as any);
+  const s: any = session;
+  if (!s || !s.user?.id) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
+  const id = Number(s.user.id);
+  const body = await req.json();
+  const data: any = {};
+  if (body.name) data.name = body.name;
+  if (body.username !== undefined) data.username = body.username || null;
+  if (body.email) data.email = body.email;
+  if (body.image !== undefined) data.image = body.image || null;
+  if (body.password) {
+    const salt = await bcrypt.genSalt(10);
+    data.password = await bcrypt.hash(body.password, salt);
+  }
+
+  try {
+    const updated = await prisma.user.update({ where: { id }, data, select: { id: true, name: true, email: true, username: true, image: true } });
+    return NextResponse.json(updated);
+  } catch (err: any) {
+    console.error(err);
+    return NextResponse.json({ error: err.message || 'Erro' }, { status: 500 });
+  }
+}
diff --git a/app/components/ProfileForm.tsx b/app/components/ProfileForm.tsx
new file mode 100644
index 0000000..6e05627
--- /dev/null
+++ b/app/components/ProfileForm.tsx
@@ -0,0 +1,138 @@
+"use client";
+
+import { useEffect, useState, useRef } from "react";
+
+type User = { id: number; name: string; email: string; username?: string | null; image?: string | null };
+
+export default function ProfileForm() {
+  const [user, setUser] = useState<User | null>(null);
+  const [name, setName] = useState("");
+  const [username, setUsername] = useState("");
+  const [email, setEmail] = useState("");
+  const [password, setPassword] = useState("");
+  const [imagePreview, setImagePreview] = useState("");
+  const [imageInput, setImageInput] = useState("");
+  const [loading, setLoading] = useState(false);
+
+  const fetchMe = async () => {
+    const res = await fetch('/api/me');
+    if (res.ok) {
+      const data = await res.json();
+      setUser(data);
+      setName(data?.name ?? '');
+      setUsername(data?.username ?? '');
+      setEmail(data?.email ?? '');
+      setImagePreview(data?.image ?? '');
+      setImageInput(data?.image ?? '');
+    }
+  };
+
+  useEffect(() => { fetchMe(); }, []);
+
+  const fileInputRef = useRef<HTMLInputElement | null>(null);
+  const onFile = (f?: File) => {
+    if (!f) return;
+    const reader = new FileReader();
+    reader.onload = () => {
+      const v = String(reader.result);
+      setImagePreview(v);
+      // clear the text input so the data URL is not shown
+      setImageInput('');
+    };
+    reader.readAsDataURL(f);
+  };
+
+  const triggerFile = () => fileInputRef.current?.click();
+
+  const removeAvatar = () => {
+    if (!confirm('Remover avatar? Isso irá usar as iniciais como avatar.')) return;
+    setImagePreview('');
+    setImageInput('');
+  };
+
+  const getInitials = (fullName = '') => {
+    const parts = fullName.trim().split(/\s+/).filter(Boolean);
+    if (parts.length === 0) return 'U';
+    if (parts.length === 1) return parts[0].slice(0, 1).toUpperCase();
+    return (parts[0].slice(0,1) + parts[parts.length-1].slice(0,1)).toUpperCase();
+  };
+
+  const submit = async (e: React.FormEvent) => {
+    e.preventDefault();
+    setLoading(true);
+    const payload: any = { name, username, email, image: imagePreview || imageInput };
+    if (password) payload.password = password;
+    const res = await fetch('/api/me', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
+    if (res.ok) {
+      alert('Perfil atualizado');
+      setPassword('');
+      await fetchMe();
+    } else {
+      const err = await res.json();
+      alert('Erro: ' + (err?.error ?? 'unknown'));
+    }
+    setLoading(false);
+  };
+
+  return (
+    <div className="mx-auto max-w-3xl">
+      <form onSubmit={submit} className="space-y-4">
+        <div>
+          <label className="block text-sm font-medium">Nome completo</label>
+          <input required value={name} onChange={(e)=>setName(e.target.value)} className="mt-1 w-full rounded-md border px-3 py-2" />
+        </div>
+
+        <div>
+          <label className="block text-sm font-medium">Username</label>
+          <input value={username ?? ''} onChange={(e)=>setUsername(e.target.value)} className="mt-1 w-full rounded-md border px-3 py-2" />
+        </div>
+
+        <div>
+          <label className="block text-sm font-medium">E-mail</label>
+          <input required type="email" value={email} onChange={(e)=>setEmail(e.target.value)} className="mt-1 w-full rounded-md border px-3 py-2" />
+        </div>
+
+        <div>
+          <label className="block text-sm font-medium">Senha (deixe em branco para manter)</label>
+          <input type="password" value={password} onChange={(e)=>setPassword(e.target.value)} className="mt-1 w-full rounded-md border px-3 py-2" />
+        </div>
+
+        <div className="flex flex-col items-center md:items-start">
+          <label className="block text-sm font-medium">Avatar (URL ou upload)</label>
+          <input value={imageInput} onChange={(e)=>setImageInput(e.target.value)} onBlur={() => { if (imageInput) setImagePreview(imageInput); }} placeholder="https://... ou base64" className="mt-1 w-full rounded-md border px-3 py-2" />
+          <div className="mt-2">
+            <input ref={fileInputRef} type="file" accept="image/*" onChange={(e)=>onFile(e.target.files?.[0])} className="hidden" />
+            <button type="button" onClick={triggerFile} className="mr-2 rounded-md border px-3 py-1 text-sm md:text-base">Procurar...</button>
+          </div>
+
+          <div className="mt-3 flex flex-col items-center md:items-start gap-2">
+            {(imagePreview || imageInput) ? (
+              <div className="flex flex-col items-center md:items-start gap-2">
+                <div className="h-24 w-24 md:h-32 md:w-32 rounded-full overflow-hidden border ring-1 ring-muted/20">
+                  <img src={imagePreview || imageInput} alt="avatar" className="h-full w-full object-cover" />
+                </div>
+                <div className="flex gap-2">
+                  <button type="button" onClick={triggerFile} className="rounded-md border px-3 py-1 text-sm">Alterar</button>
+                  <button type="button" onClick={removeAvatar} className="rounded-md border px-3 py-1 text-sm text-red-600">Remover</button>
+                </div>
+              </div>
+            ) : (
+              <div className="flex flex-col items-center md:items-start gap-2">
+                <div className="h-24 w-24 md:h-32 md:w-32 rounded-full overflow-hidden border ring-1 ring-muted/20 flex items-center justify-center bg-muted text-white text-xl font-semibold">
+                  {getInitials(name)}
+                </div>
+                <div className="flex gap-2">
+                  <button type="button" onClick={triggerFile} className="rounded-md border px-3 py-1 text-sm">Adicionar</button>
+                </div>
+              </div>
+            )}
+          </div>
+        </div>
+
+        <div>
+          <button type="submit" disabled={loading} className="w-full md:w-auto rounded-md bg-primary px-4 py-2 text-white">{loading ? 'Salvando...' : 'Salvar alterações'}</button>
+        </div>
+      </form>
+    </div>
+  );
+}
diff --git a/app/perfil/page.tsx b/app/perfil/page.tsx
index fc15661..5c210ee 100644
--- a/app/perfil/page.tsx
+++ b/app/perfil/page.tsx
@@ -1,4 +1,5 @@
 import PageLayout from "@/app/components/PageLayout";
+import ProfileForm from '@/app/components/ProfileForm';
 
 export const dynamic = "force-dynamic";
 export const revalidate = 0;
@@ -13,6 +14,9 @@ export default function PerfilPage() {
           <p className="text-muted-foreground">Configurações do usuário e preferências.</p>
         </header>
       </div>
+      <div className="mt-8">
+        <ProfileForm />
+      </div>
     </PageLayout>
   );
 }
diff --git a/dev.log b/dev.log
index 405d88b..adfdf42 100644
--- a/dev.log
+++ b/dev.log
@@ -452,3 +452,159 @@ prisma:query SELECT `main`.`TipoEquipamento`.`id`, `main`.`TipoEquipamento`.`nom
  GET /api/equipamentos?areaId=2 200 in 9ms (compile: 4ms, render: 5ms)
 prisma:query SELECT `main`.`Equipamento`.`id`, `main`.`Equipamento`.`nome`, `main`.`Equipamento`.`tag`, `main`.`Equipamento`.`descricao`, `main`.`Equipamento`.`ativo`, `main`.`Equipamento`.`areaId`, `main`.`Equipamento`.`tipoId`, `main`.`Equipamento`.`createdAt`, `main`.`Equipamento`.`updatedAt` FROM `main`.`Equipamento` WHERE `main`.`Equipamento`.`areaId` = ? LIMIT ? OFFSET ?
 prisma:query SELECT `main`.`Area`.`id`, `main`.`Area`.`nome`, `main`.`Area`.`descricao`, `main`.`Area`.`ativo`, `main`.`Area`.`createdAt`, `main`.`Area`.`updatedAt` FROM `main`.`Area` WHERE `main`.`Area`.`id` IN (?) LIMIT ? OFFSET ?
+prisma:query SELECT 1
+prisma:query UPDATE `main`.`Equipamento` SET `nome` = ?, `tag` = ?, `descricao` = ?, `ativo` = ?, `areaId` = ?, `tipoId` = ?, `updatedAt` = ? WHERE (`main`.`Equipamento`.`id` = ? AND 1=1) RETURNING `id` AS `id`, `nome` AS `nome`, `tag` AS `tag`, `descricao` AS `descricao`, `ativo` AS `ativo`, `areaId` AS `areaId`, `tipoId` AS `tipoId`, `createdAt` AS `createdAt`, `updatedAt` AS `updatedAt`
+ PUT /api/equipamentos/5 200 in 613ms (compile: 602ms, render: 11ms)
+ GET /api/equipamentos?areaId=2 200 in 7ms (compile: 1920µs, render: 6ms)
+prisma:query SELECT `main`.`Equipamento`.`id`, `main`.`Equipamento`.`nome`, `main`.`Equipamento`.`tag`, `main`.`Equipamento`.`descricao`, `main`.`Equipamento`.`ativo`, `main`.`Equipamento`.`areaId`, `main`.`Equipamento`.`tipoId`, `main`.`Equipamento`.`createdAt`, `main`.`Equipamento`.`updatedAt` FROM `main`.`Equipamento` WHERE `main`.`Equipamento`.`areaId` = ? LIMIT ? OFFSET ?
+prisma:query SELECT `main`.`Area`.`id`, `main`.`Area`.`nome`, `main`.`Area`.`descricao`, `main`.`Area`.`ativo`, `main`.`Area`.`createdAt`, `main`.`Area`.`updatedAt` FROM `main`.`Area` WHERE `main`.`Area`.`id` IN (?) LIMIT ? OFFSET ?
+ GET /areas 200 in 18ms (compile: 3ms, render: 15ms)
+ GET /api/areas 200 in 6ms (compile: 1666µs, render: 5ms)
+prisma:query SELECT 1
+prisma:query SELECT `main`.`Area`.`id`, `main`.`Area`.`nome`, `main`.`Area`.`descricao`, `main`.`Area`.`ativo`, `main`.`Area`.`createdAt`, `main`.`Area`.`updatedAt` FROM `main`.`Area` WHERE 1=1 LIMIT ? OFFSET ?
+prisma:query SELECT `main`.`Equipamento`.`id`, `main`.`Equipamento`.`nome`, `main`.`Equipamento`.`tag`, `main`.`Equipamento`.`descricao`, `main`.`Equipamento`.`ativo`, `main`.`Equipamento`.`areaId`, `main`.`Equipamento`.`tipoId`, `main`.`Equipamento`.`createdAt`, `main`.`Equipamento`.`updatedAt` FROM `main`.`Equipamento` WHERE `main`.`Equipamento`.`areaId` IN (?,?,?,?) LIMIT ? OFFSET ?
+ GET /api/areas 200 in 7ms (compile: 1894µs, render: 5ms)
+prisma:query SELECT `main`.`Area`.`id`, `main`.`Area`.`nome`, `main`.`Area`.`descricao`, `main`.`Area`.`ativo`, `main`.`Area`.`createdAt`, `main`.`Area`.`updatedAt` FROM `main`.`Area` WHERE 1=1 LIMIT ? OFFSET ?
+prisma:query SELECT `main`.`Equipamento`.`id`, `main`.`Equipamento`.`nome`, `main`.`Equipamento`.`tag`, `main`.`Equipamento`.`descricao`, `main`.`Equipamento`.`ativo`, `main`.`Equipamento`.`areaId`, `main`.`Equipamento`.`tipoId`, `main`.`Equipamento`.`createdAt`, `main`.`Equipamento`.`updatedAt` FROM `main`.`Equipamento` WHERE `main`.`Equipamento`.`areaId` IN (?,?,?,?) LIMIT ? OFFSET ?
+ GET /historico 200 in 17ms (compile: 1837µs, render: 15ms)
+ GET /paradas-ativas 200 in 17ms (compile: 1809µs, render: 15ms)
+prisma:query BEGIN IMMEDIATE
+prisma:query SELECT COUNT(*) AS `_count$_all` FROM (SELECT `main`.`Area`.`id` FROM `main`.`Area` WHERE 1=1 LIMIT ? OFFSET ?) AS `sub`
+prisma:query SELECT COUNT(*) AS `_count$_all` FROM (SELECT `main`.`Equipamento`.`id` FROM `main`.`Equipamento` WHERE 1=1 LIMIT ? OFFSET ?) AS `sub`
+prisma:query SELECT COUNT(*) AS `_count$_all` FROM (SELECT `main`.`Parada`.`id` FROM `main`.`Parada` WHERE 1=1 LIMIT ? OFFSET ?) AS `sub`
+prisma:query SELECT COUNT(*) AS `_count$_all` FROM (SELECT `main`.`Teste`.`id` FROM `main`.`Teste` WHERE 1=1 LIMIT ? OFFSET ?) AS `sub`
+prisma:query SELECT COUNT(*) AS `_count$_all`, `main`.`Teste`.`status` FROM `main`.`Teste` WHERE 1=1 GROUP BY `main`.`Teste`.`status` ORDER BY `main`.`Teste`.`status` ASC LIMIT ? OFFSET ?
+prisma:query COMMIT
+prisma:query SELECT `main`.`Parada`.`id`, `main`.`Parada`.`macro`, `main`.`Parada`.`nome`, `main`.`Parada`.`descricao`, `main`.`Parada`.`equipeResponsavel`, `main`.`Parada`.`dataInicio`, `main`.`Parada`.`dataFim`, `main`.`Parada`.`duracaoPrevistaHoras`, `main`.`Parada`.`status`, `main`.`Parada`.`tipo`, `main`.`Parada`.`createdAt`, `main`.`Parada`.`updatedAt` FROM `main`.`Parada` WHERE 1=1 ORDER BY `main`.`Parada`.`dataInicio` DESC LIMIT ? OFFSET ?
+prisma:query SELECT `main`.`Teste`.`id`, `main`.`Teste`.`paradaId`, `main`.`Teste`.`equipamentoId`, `main`.`Teste`.`status`, `main`.`Teste`.`observacoes`, `main`.`Teste`.`problemaDescricao`, `main`.`Teste`.`dataTeste`, `main`.`Teste`.`testadoPor`, `main`.`Teste`.`naoAplica`, `main`.`Teste`.`createdAt`, `main`.`Teste`.`updatedAt` FROM `main`.`Teste` WHERE `main`.`Teste`.`paradaId` IN (?,?,?) LIMIT ? OFFSET ?
+ GET /dashboard 200 in 35ms (compile: 2ms, proxy.ts: 5ms, render: 27ms)
+ GET /check-templates 200 in 15ms (compile: 2ms, render: 12ms)
+prisma:query SELECT `main`.`TipoEquipamento`.`id`, `main`.`TipoEquipamento`.`nome`, `main`.`TipoEquipamento`.`descricao`, `main`.`TipoEquipamento`.`ativo`, `main`.`TipoEquipamento`.`createdAt`, `main`.`TipoEquipamento`.`updatedAt` FROM `main`.`TipoEquipamento` WHERE 1=1 LIMIT ? OFFSET ?
+ GET /api/tipos 200 in 7ms (compile: 2ms, render: 5ms)
+ GET /api/check-templates 200 in 7ms (compile: 3ms, render: 5ms)
+prisma:query SELECT `main`.`CheckTemplate`.`id`, `main`.`CheckTemplate`.`tipoId`, `main`.`CheckTemplate`.`nome`, `main`.`CheckTemplate`.`descricao`, `main`.`CheckTemplate`.`ordem`, `main`.`CheckTemplate`.`obrigatorio`, `main`.`CheckTemplate`.`createdAt`, `main`.`CheckTemplate`.`updatedAt` FROM `main`.`CheckTemplate` WHERE 1=1 LIMIT ? OFFSET ?
+ GET /api/tipos 200 in 8ms (compile: 4ms, render: 4ms)
+prisma:query SELECT `main`.`TipoEquipamento`.`id`, `main`.`TipoEquipamento`.`nome`, `main`.`TipoEquipamento`.`descricao`, `main`.`TipoEquipamento`.`ativo`, `main`.`TipoEquipamento`.`createdAt`, `main`.`TipoEquipamento`.`updatedAt` FROM `main`.`TipoEquipamento` WHERE 1=1 LIMIT ? OFFSET ?
+prisma:query SELECT `main`.`CheckTemplate`.`id`, `main`.`CheckTemplate`.`tipoId`, `main`.`CheckTemplate`.`nome`, `main`.`CheckTemplate`.`descricao`, `main`.`CheckTemplate`.`ordem`, `main`.`CheckTemplate`.`obrigatorio`, `main`.`CheckTemplate`.`createdAt`, `main`.`CheckTemplate`.`updatedAt` FROM `main`.`CheckTemplate` WHERE 1=1 LIMIT ? OFFSET ?
+ GET /api/check-templates 200 in 7ms (compile: 1718µs, render: 6ms)
+ GET /perfil 200 in 14ms (compile: 1666µs, render: 13ms)
+ GET /perfil 200 in 150ms (compile: 75ms, render: 75ms)
+ GET /historico 200 in 150ms (compile: 122ms, render: 28ms)
+ GET /perfil 200 in 29ms (compile: 2ms, render: 26ms)
+ GET /historico 200 in 29ms (compile: 16ms, render: 13ms)
+ GET /historico 200 in 33ms (compile: 1866µs, render: 31ms)
+ GET /perfil 200 in 16ms (compile: 1425µs, render: 15ms)
+ GET /historico 200 in 32ms (compile: 1665µs, render: 30ms)
+ GET /perfil 200 in 18ms (compile: 1579µs, render: 16ms)
+ GET /historico 200 in 29ms (compile: 1719µs, render: 27ms)
+ GET /perfil 200 in 16ms (compile: 1333µs, render: 15ms)
+ GET /historico 200 in 26ms (compile: 1556µs, render: 25ms)
+ GET /perfil 200 in 14ms (compile: 1463µs, render: 12ms)
+ GET /historico 200 in 29ms (compile: 1616µs, render: 27ms)
+ GET /perfil 200 in 16ms (compile: 1751µs, render: 14ms)
+ GET /historico 200 in 32ms (compile: 1942µs, render: 30ms)
+ GET /perfil 200 in 18ms (compile: 2ms, render: 16ms)
+ GET /historico 200 in 29ms (compile: 1932µs, render: 27ms)
+ GET /perfil 200 in 15ms (compile: 1543µs, render: 14ms)
+ GET /historico 200 in 30ms (compile: 1929µs, render: 28ms)
+ GET /perfil 200 in 16ms (compile: 1720µs, render: 15ms)
+ GET /historico 200 in 41ms (compile: 1827µs, render: 39ms)
+ GET /perfil 200 in 39ms (compile: 1706µs, render: 37ms)
+ GET /historico 200 in 18ms (compile: 2ms, render: 16ms)
+ GET /historico 200 in 36ms (compile: 12ms, render: 25ms)
+ GET /perfil 200 in 41ms (compile: 27ms, render: 14ms)
+ GET /historico 200 in 29ms (compile: 5ms, render: 24ms)
+ GET /perfil 200 in 14ms (compile: 1533µs, render: 13ms)
+ GET /historico 200 in 26ms (compile: 1575µs, render: 24ms)
+ GET /perfil 200 in 14ms (compile: 1681µs, render: 12ms)
+ GET /historico 200 in 30ms (compile: 1503µs, render: 28ms)
+ GET /perfil 200 in 14ms (compile: 1540µs, render: 12ms)
+ GET /historico 200 in 27ms (compile: 1573µs, render: 26ms)
+ GET /perfil 200 in 15ms (compile: 1497µs, render: 14ms)
+ GET /historico 200 in 32ms (compile: 1944µs, render: 30ms)
+ GET /perfil 200 in 20ms (compile: 1566µs, render: 18ms)
+ GET /historico 200 in 27ms (compile: 1584µs, render: 25ms)
+ GET /perfil 200 in 14ms (compile: 1866µs, render: 12ms)
+ GET /historico 200 in 29ms (compile: 1800µs, render: 27ms)
+ GET /perfil 200 in 15ms (compile: 3ms, render: 13ms)
+ GET /historico 200 in 30ms (compile: 1731µs, render: 28ms)
+ GET /perfil 200 in 14ms (compile: 1446µs, render: 13ms)
+ GET /historico 200 in 28ms (compile: 2ms, render: 26ms)
+ GET /perfil 200 in 14ms (compile: 1605µs, render: 13ms)
+ GET /historico 200 in 29ms (compile: 1593µs, render: 28ms)
+ GET /perfil 200 in 17ms (compile: 1539µs, render: 15ms)
+ GET /historico 200 in 29ms (compile: 1577µs, render: 28ms)
+ GET /perfil 200 in 15ms (compile: 1548µs, render: 14ms)
+ GET /historico 200 in 24ms (compile: 1436µs, render: 23ms)
+ GET /perfil 200 in 13ms (compile: 1542µs, render: 12ms)
+ GET /historico 200 in 30ms (compile: 1665µs, render: 29ms)
+ GET /perfil 200 in 14ms (compile: 1733µs, render: 13ms)
+ GET /historico 200 in 25ms (compile: 1419µs, render: 24ms)
+ GET /perfil 200 in 13ms (compile: 1473µs, render: 12ms)
+ GET /historico 200 in 28ms (compile: 1548µs, render: 26ms)
+ GET /perfil 200 in 16ms (compile: 1588µs, render: 14ms)
+ GET /historico 200 in 24ms (compile: 1482µs, render: 23ms)
+ GET /perfil 200 in 13ms (compile: 1360µs, render: 12ms)
+ GET /historico 200 in 24ms (compile: 1528µs, render: 23ms)
+ GET /perfil 200 in 13ms (compile: 1491µs, render: 11ms)
+ GET /historico 200 in 28ms (compile: 1762µs, render: 26ms)
+ GET /perfil 200 in 13ms (compile: 1491µs, render: 12ms)
+ GET /historico 200 in 25ms (compile: 1580µs, render: 23ms)
+ GET /perfil 200 in 13ms (compile: 1650µs, render: 11ms)
+ GET /historico 200 in 27ms (compile: 1421µs, render: 26ms)
+ GET /perfil 200 in 16ms (compile: 1468µs, render: 14ms)
+ GET /historico 200 in 24ms (compile: 1565µs, render: 22ms)
+ GET /perfil 200 in 12ms (compile: 1322µs, render: 11ms)
+ GET /historico 200 in 24ms (compile: 1475µs, render: 23ms)
+ GET /perfil 200 in 13ms (compile: 1520µs, render: 11ms)
+ GET /historico 200 in 29ms (compile: 1994µs, render: 27ms)
+ GET /perfil 200 in 14ms (compile: 1592µs, render: 13ms)
+ GET /historico 200 in 24ms (compile: 1506µs, render: 22ms)
+ GET /perfil 200 in 13ms (compile: 1414µs, render: 11ms)
+ GET /historico 200 in 27ms (compile: 1438µs, render: 26ms)
+ GET /perfil 200 in 16ms (compile: 1520µs, render: 14ms)
+ GET /historico 200 in 24ms (compile: 1566µs, render: 22ms)
+ GET /perfil 200 in 13ms (compile: 1352µs, render: 11ms)
+ GET /historico 200 in 26ms (compile: 1811µs, render: 24ms)
+ GET /perfil 200 in 13ms (compile: 1521µs, render: 11ms)
+ GET /historico 200 in 27ms (compile: 1457µs, render: 26ms)
+ GET /perfil 200 in 13ms (compile: 1480µs, render: 12ms)
+ GET /historico 200 in 24ms (compile: 1405µs, render: 23ms)
+ GET /perfil 200 in 13ms (compile: 1451µs, render: 11ms)
+ GET /historico 200 in 27ms (compile: 1364µs, render: 25ms)
+ GET /perfil 200 in 16ms (compile: 1521µs, render: 14ms)
+ GET /historico 200 in 24ms (compile: 1665µs, render: 22ms)
+ GET /perfil 200 in 13ms (compile: 1439µs, render: 11ms)
+ GET /historico 200 in 24ms (compile: 1514µs, render: 23ms)
+ GET /perfil 200 in 13ms (compile: 1475µs, render: 11ms)
+ GET /historico 200 in 27ms (compile: 1483µs, render: 26ms)
+ GET /perfil 200 in 13ms (compile: 1515µs, render: 12ms)
+ GET /historico 200 in 23ms (compile: 1424µs, render: 22ms)
+ GET /perfil 200 in 12ms (compile: 1328µs, render: 11ms)
+ GET /historico 200 in 26ms (compile: 1369µs, render: 25ms)
+ GET /perfil 200 in 15ms (compile: 1234µs, render: 14ms)
+ GET /perfil 200 in 13ms (compile: 1447µs, render: 12ms)
+ ✓ Compiled in 44ms
+ ✓ Compiled in 62ms
+ ✓ Compiled in 82ms
+ GET /historico 200 in 134ms (compile: 5ms, render: 130ms)
+ GET /perfil 200 in 118ms (compile: 87ms, render: 31ms)
+ GET /api/me 200 in 499ms (compile: 431ms, render: 69ms)
+prisma:query SELECT 1
+prisma:query SELECT `main`.`User`.`id`, `main`.`User`.`name`, `main`.`User`.`email`, `main`.`User`.`username`, `main`.`User`.`image` FROM `main`.`User` WHERE (`main`.`User`.`id` = ? AND 1=1) LIMIT ? OFFSET ?
+prisma:query SELECT `main`.`User`.`id`, `main`.`User`.`name`, `main`.`User`.`email`, `main`.`User`.`username`, `main`.`User`.`image` FROM `main`.`User` WHERE (`main`.`User`.`id` = ? AND 1=1) LIMIT ? OFFSET ?
+ GET /api/me 200 in 514ms (compile: 495ms, render: 19ms)
+ ✓ Compiled in 51ms
+ ✓ Compiled in 41ms
+prisma:query SELECT 1
+prisma:query SELECT `main`.`User`.`id`, `main`.`User`.`name`, `main`.`User`.`email`, `main`.`User`.`username`, `main`.`User`.`image` FROM `main`.`User` WHERE (`main`.`User`.`id` = ? AND 1=1) LIMIT ? OFFSET ?
+ GET /api/me 200 in 13ms (compile: 3ms, render: 11ms)
+ ✓ Compiled in 40ms
+prisma:query SELECT 1
+ GET /api/me 200 in 10ms (compile: 1513µs, render: 9ms)
+prisma:query SELECT `main`.`User`.`id`, `main`.`User`.`name`, `main`.`User`.`email`, `main`.`User`.`username`, `main`.`User`.`image` FROM `main`.`User` WHERE (`main`.`User`.`id` = ? AND 1=1) LIMIT ? OFFSET ?
+ ✓ Compiled in 24ms
+ GET /perfil 200 in 245ms (compile: 81ms, render: 164ms)
+prisma:query SELECT 1
+prisma:query SELECT `main`.`User`.`id`, `main`.`User`.`name`, `main`.`User`.`email`, `main`.`User`.`username`, `main`.`User`.`image` FROM `main`.`User` WHERE (`main`.`User`.`id` = ? AND 1=1) LIMIT ? OFFSET ?
+ GET /api/me 200 in 12ms (compile: 2ms, render: 10ms)
diff --git a/lib/nextAuthOptions.ts b/lib/nextAuthOptions.ts
new file mode 100644
index 0000000..d9dc39c
--- /dev/null
+++ b/lib/nextAuthOptions.ts
@@ -0,0 +1,54 @@
+import CredentialsProvider from "next-auth/providers/credentials";
+import { compare } from "bcryptjs";
+import { PrismaAdapter } from "@next-auth/prisma-adapter";
+import { prisma } from "./prisma";
+
+export const authOptions = {
+  adapter: PrismaAdapter(prisma),
+  session: {
+    strategy: "jwt",
+  },
+  providers: [
+    CredentialsProvider({
+      name: "E-mail e senha",
+      credentials: {
+        email: { label: "E-mail", type: "text" },
+        password: { label: "Senha", type: "password" },
+      },
+      async authorize(credentials) {
+        if (!credentials?.email || !credentials.password) {
+          return null;
+        }
+
+        const user = await prisma.user.findUnique({
+          where: { email: credentials.email },
+        });
+
+        if (!user) return null;
+
+        const isValid = await compare(credentials.password, user.password);
+        if (!isValid) return null;
+
+        return {
+          id: user.id.toString(),
+          name: user.name,
+          email: user.email,
+        };
+      },
+    }),
+  ],
+  callbacks: {
+    async session({ session, token }: any) {
+      if (session.user && token.sub) {
+        session.user.id = token.sub;
+      }
+      return session;
+    },
+  },
+  pages: {
+    signIn: "/login",
+  },
+  secret: process.env.NEXTAUTH_SECRET,
+};
+
+export default authOptions;
-- 
2.34.1

